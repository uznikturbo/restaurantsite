{% extends "base.html" %}
{% block title %}Столики — Адмін{% endblock %}

{% block extra_css %}
<style>
.admin-nav { display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:2.5rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(26,18,8,.08); }
.admin-nav a { padding:.5rem 1.25rem;border-radius:2px;font-size:.78rem;letter-spacing:.08em;text-transform:uppercase;text-decoration:none;border:1px solid rgba(26,18,8,.15);color:rgba(26,18,8,.55);transition:all .2s; }
.admin-nav a:hover { border-color:var(--ink);color:var(--ink); }
.admin-nav a.active { background:var(--ink);color:#fff;border-color:var(--ink); }

.page-head { margin-bottom:2.5rem; }
.page-head__eyebrow { font-size:.7rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);margin-bottom:.4rem; }
.page-head__title { font-family:'Cormorant Garamond',serif;font-size:2.2rem;font-weight:300; }

/* Add form */
.add-card { background:#fff;border:1px solid rgba(26,18,8,.07);border-radius:6px;padding:2rem;margin-bottom:1.5rem; }
.add-card__title { font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:400;margin-bottom:1.5rem; }
.add-form { display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end; }
.add-form .field { flex:1;min-width:160px; }
.add-form .field input { padding:.75rem 1rem;font-size:.9rem; }

.type-btns { display:flex;gap:.5rem;flex-wrap:wrap; }
.type-btn {
    padding:.55rem 1.1rem;border:1px solid rgba(26,18,8,.15);border-radius:2px;
    background:transparent;font-size:.78rem;letter-spacing:.06em;text-transform:uppercase;
    cursor:pointer;transition:all .2s;color:rgba(26,18,8,.55);
}
.type-btn:hover { border-color:var(--ink);color:var(--ink); }
.type-btn.active { background:var(--ink);color:#fff;border-color:var(--ink); }

/* Floor */
.floor-card { background:#fff;border:1px solid rgba(26,18,8,.07);border-radius:6px;overflow:hidden; }
.floor-card__head { padding:1.25rem 1.5rem;border-bottom:1px solid rgba(26,18,8,.06);display:flex;justify-content:space-between;align-items:center; }
.floor-card__title { font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:400; }
.unsaved { font-size:.75rem;color:#92400e;background:#fef3c7;padding:.3rem .7rem;border-radius:2px;display:none; }
.unsaved.visible { display:inline; }

.floor-surface {
    position:relative;
    height:560px;
    background:#a08570;
    overflow:hidden;
}

.at-wrap {
    position:absolute;
    cursor:grab;user-select:none;
}
.at-wrap.dragging { cursor:grabbing;opacity:.85;z-index:50; }
.at-wrap:hover .at-del { opacity:1; }
.at-wrap.new-table { animation:popIn .3s ease; }
@keyframes popIn { 0%{transform:scale(0)}60%{transform:scale(1.1)}100%{transform:scale(1)} }

.at-top {
    display:flex;align-items:center;justify-content:center;
    background:radial-gradient(circle at 30% 30%,#a0522d,#5a3012);
    border:3px solid #3d1e0a;
    color:#f4c430;
    font-family:'Cormorant Garamond',serif;
    font-size:1.4rem;
    font-weight:400;
    box-shadow:0 6px 20px rgba(0,0,0,.4),inset 0 1px 3px rgba(255,255,255,.12);
    position:relative;
}
.at--round .at-top { width:90px;height:90px;border-radius:50%; }
.at--square .at-top { width:90px;height:90px;border-radius:12px; }
.at--large .at-top { width:150px;height:78px;border-radius:14px; }

.at-del {
    position:absolute;top:-8px;right:-8px;
    width:22px;height:22px;border-radius:50%;
    background:#ef4444;color:#fff;border:2px solid #fff;
    font-size:.85rem;cursor:pointer;opacity:0;transition:opacity .2s;
    display:flex;align-items:center;justify-content:center;line-height:1;
}
.at-del:hover { background:#dc2626; }

.bar-fixed {
    position:absolute;right:0;top:50%;transform:translateY(-50%);
    width:60px;height:320px;
    background:linear-gradient(180deg,#3d2010,#1e0f08);
    border-radius:10px 0 0 10px;
    border:3px solid #1a0a04;border-right:none;
    box-shadow:-4px 0 20px rgba(0,0,0,.5);
    display:flex;align-items:center;justify-content:center;
    z-index:5;
}
.bar-fixed span {
    writing-mode:vertical-rl;
    font-family:'Cormorant Garamond',serif;
    font-size:.8rem;letter-spacing:.2em;text-transform:uppercase;
    color:rgba(201,168,76,.7);
}

.floor-card__foot { padding:1.25rem 1.5rem;border-top:1px solid rgba(26,18,8,.06);display:flex;gap:.75rem;align-items:center; }
</style>
{% endblock %}

{% block content %}
<nav class="admin-nav">
    <a href="{{ url_for('main.admin_dashboard') }}">Дашборд</a>
    <a href="{{ url_for('main.admin_orders') }}">Замовлення</a>
    <a href="{{ url_for('main.admin_products') }}">Товари</a>
    <a href="{{ url_for('main.admin_users') }}">Користувачі</a>
    <a href="{{ url_for('main.admin_tables') }}" class="active">Столики</a>
</nav>

<div class="page-head">
    <div class="page-head__eyebrow">Адміністрування</div>
    <h1 class="page-head__title">Столики</h1>
</div>

<div class="add-card">
    <div class="add-card__title">Додати столик</div>
    <div class="add-form">
        <div class="field">
            <label>Номер</label>
            <input type="number" id="tNum" placeholder="7" min="1">
        </div>
        <div class="field">
            <label>Тип</label>
            <div class="type-btns">
                <button class="type-btn" data-type="round" onclick="pickType(this)">Круглий</button>
                <button class="type-btn" data-type="square" onclick="pickType(this)">Квадратний</button>
                <button class="type-btn" data-type="large" onclick="pickType(this)">Великий</button>
            </div>
        </div>
        <button class="btn btn--primary" onclick="addTable()">Додати</button>
    </div>
</div>

<div class="floor-card">
    <div class="floor-card__head">
        <span class="floor-card__title">План залу — перетягуйте столики</span>
        <span class="unsaved" id="unsaved">⚠ Незбережені зміни</span>
    </div>
    <div class="floor-surface" id="floor">
        <div class="bar-fixed"><span>Bar</span></div>

        {% for t in tables %}
        <div class="at-wrap at--{{ t.type }}"
             data-id="{{ t.id }}"
             data-number="{{ t.number }}"
             data-type="{{ t.type }}"
             style="left:{{ t.x }}px;top:{{ t.y }}px;">
            <div class="at-top">
                {{ t.number }}
                <span class="at-del" onclick="delTable(this)">×</span>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="floor-card__foot">
        <button class="btn btn--primary" id="saveBtn" disabled onclick="saveTables()">Зберегти зміни</button>
        <span style="font-size:.8rem;color:rgba(26,18,8,.4)">Зміни зберігаються на сервері</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let changed = false;
let dragged = null, ox = 0, oy = 0;
let selectedType = null;
let newIdx = 0;
const floor = document.getElementById('floor');

function pickType(btn) {
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedType = btn.dataset.type;
}

function addTable() {
    const num = document.getElementById('tNum').value.trim();
    if (!num) { alert('Введіть номер'); return; }
    if (!selectedType) { alert('Оберіть тип'); return; }
    const exists = [...document.querySelectorAll('.at-wrap')].some(w => w.dataset.number == num);
    if (exists) { alert('Такий номер вже є'); return; }
    const el = document.createElement('div');
    el.className = `at-wrap at--${selectedType} new-table`;
    el.dataset.id = `new_${newIdx++}`;
    el.dataset.number = num;
    el.dataset.type = selectedType;
    el.style.left = '60px';
    el.style.top = '60px';
    el.innerHTML = `<div class="at-top">${num}<span class="at-del" onclick="delTable(this)">×</span></div>`;
    floor.appendChild(el);
    initDrag(el);
    document.getElementById('tNum').value = '';
    markChanged();
}

document.querySelectorAll('.at-wrap').forEach(initDrag);

function initDrag(el) {
    el.addEventListener('mousedown', e => {
        if (e.target.classList.contains('at-del')) return;
        dragged = el;
        const r = el.getBoundingClientRect();
        ox = e.clientX - r.left;
        oy = e.clientY - r.top;
        el.classList.add('dragging');
    });
}

document.addEventListener('mousemove', e => {
    if (!dragged) return;
    const fr = floor.getBoundingClientRect();
    let x = Math.max(0, Math.min(e.clientX - fr.left - ox, fr.width - dragged.offsetWidth));
    let y = Math.max(0, Math.min(e.clientY - fr.top - oy, fr.height - dragged.offsetHeight));
    dragged.style.left = x + 'px';
    dragged.style.top = y + 'px';
});

document.addEventListener('mouseup', () => {
    if (!dragged) return;
    dragged.classList.remove('dragging');
    dragged = null;
    markChanged();
});

function delTable(btn) {
    if (!confirm('Видалити цей столик?')) return;
    btn.closest('.at-wrap').remove();
    markChanged();
}

function markChanged() {
    changed = true;
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('unsaved').classList.add('visible');
}

async function saveTables() {
    const data = [...document.querySelectorAll('.at-wrap')].map(el => ({
        id: el.dataset.id,
        number: parseInt(el.dataset.number),
        type: el.dataset.type,
        x: parseInt(el.style.left),
        y: parseInt(el.style.top)
    }));
    try {
        const r = await fetch('/admin/tables/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tables: data })
        });
        const res = await r.json();
        if (res.success) {
            changed = false;
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('unsaved').classList.remove('visible');
            location.reload();
        } else { alert('Помилка: ' + res.error); }
    } catch { alert('Помилка з\'єднання'); }
}

window.addEventListener('beforeunload', e => { if (changed) { e.preventDefault(); e.returnValue = ''; } });
</script>
{% endblock %}
