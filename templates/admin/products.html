{% extends "base.html" %}
{% block title %}–¢–æ–≤–∞—Ä–∏ ‚Äî –ê–¥–º—ñ–Ω{% endblock %}

{% block extra_css %}
<style>
.admin-nav { display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:2.5rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(26,18,8,.08); }
.admin-nav a { padding:.5rem 1.25rem;border-radius:2px;font-size:.78rem;letter-spacing:.08em;text-transform:uppercase;text-decoration:none;border:1px solid rgba(26,18,8,.15);color:rgba(26,18,8,.55);transition:all .2s; }
.admin-nav a:hover { border-color:var(--ink);color:var(--ink); }
.admin-nav a.active { background:var(--ink);color:#fff;border-color:var(--ink); }

.page-head { margin-bottom:2.5rem; }
.page-head__eyebrow { font-size:.7rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);margin-bottom:.4rem; }
.page-head__title { font-family:'Cormorant Garamond',serif;font-size:2.2rem;font-weight:300; }

/* Add product form */
.add-section { background:#fff;border:1px solid rgba(26,18,8,.07);border-radius:6px;padding:2rem;margin-bottom:2.5rem; }
.add-section__title { font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:400;margin-bottom:1.75rem; }

.product-form { display:grid;grid-template-columns:300px 1fr;gap:2rem; }

.upload-area {
    aspect-ratio:1;border:2px dashed rgba(26,18,8,.15);border-radius:6px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    cursor:pointer;transition:all .2s;background:var(--paper);
    position:relative;overflow:hidden;
}
.upload-area:hover { border-color:var(--ink);background:#fff; }
.upload-area__icon { font-size:2rem;margin-bottom:.5rem;opacity:.4; }
.upload-area__text { font-size:.78rem;letter-spacing:.05em;text-transform:uppercase;color:rgba(26,18,8,.4); }
.upload-area__hint { font-size:.72rem;color:rgba(26,18,8,.3);margin-top:.25rem; }
.upload-area img { position:absolute;inset:0;width:100%;height:100%;object-fit:cover; }
.upload-area__rm {
    position:absolute;top:.5rem;right:.5rem;
    width:28px;height:28px;
    background:var(--red);color:#fff;
    border:none;border-radius:50%;cursor:pointer;
    font-size:1rem;display:flex;align-items:center;justify-content:center;
    opacity:0;transition:opacity .2s;
}
.upload-area:hover .upload-area__rm { opacity:1; }
#fileInput { display:none; }

.divider { display:flex;align-items:center;gap:.75rem;margin:.75rem 0;color:rgba(26,18,8,.3);font-size:.75rem;letter-spacing:.1em;text-transform:uppercase; }
.divider::before,.divider::after { content:'';flex:1;height:1px;background:rgba(26,18,8,.1); }

.form-right { display:grid;grid-template-columns:repeat(2,1fr);gap:1rem 1.5rem; }
.form-right .field--full { grid-column:1/-1; }
.form-right .btn { grid-column:1/-1;justify-content:center;padding:.85rem;margin-top:.5rem; }

/* Products table */
.products-section { background:#fff;border:1px solid rgba(26,18,8,.07);border-radius:6px;overflow:hidden; }
.products-section__head { padding:1.25rem 1.5rem;border-bottom:1px solid rgba(26,18,8,.06); }
.products-section__title { font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:400; }

table { width:100%;border-collapse:collapse; }
th { padding:.75rem 1rem;text-align:left;font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;color:rgba(26,18,8,.4);border-bottom:1px solid rgba(26,18,8,.08); }
td { padding:.9rem 1rem;border-bottom:1px solid rgba(26,18,8,.05);font-size:.88rem; }
tr:last-child td { border:none; }
tbody tr:hover { background:var(--paper); }
.product-thumb { width:56px;height:56px;object-fit:cover;border-radius:4px;display:block; }
.product-name { font-weight:500; }
.product-cat { font-size:.78rem;color:rgba(26,18,8,.4); }

@media (max-width:900px) { .product-form { grid-template-columns:1fr; } .form-right { grid-template-columns:1fr; } }
@media (max-width:600px) { th:nth-child(2),td:nth-child(2) { display:none; } }
</style>
{% endblock %}

{% block content %}
<nav class="admin-nav">
    <a href="{{ url_for('main.admin_dashboard') }}">–î–∞—à–±–æ—Ä–¥</a>
    <a href="{{ url_for('main.admin_orders') }}">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
    <a href="{{ url_for('main.admin_products') }}" class="active">–¢–æ–≤–∞—Ä–∏</a>
    <a href="{{ url_for('main.admin_users') }}">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</a>
    <a href="{{ url_for('main.admin_tables') }}">–°—Ç–æ–ª–∏–∫–∏</a>
</nav>

<div class="page-head">
    <div class="page-head__eyebrow">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è</div>
    <h1 class="page-head__title">–¢–æ–≤–∞—Ä–∏</h1>
</div>

<div class="add-section">
    <div class="add-section__title">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</div>
    <form action="{{ url_for('main.admin_add_product') }}" method="POST" enctype="multipart/form-data" class="product-form" id="productForm">
        {{ form.hidden_tag() }}
        <div>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-area__icon">üñº</div>
                <div class="upload-area__text">–§–æ—Ç–æ —Ç–æ–≤–∞—Ä—É</div>
                <div class="upload-area__hint">JPG, PNG, WEBP –¥–æ 5 –ú–ë</div>
                <button type="button" class="upload-area__rm" id="rmBtn" onclick="removeImg(event)">√ó</button>
            </div>
            {{ form.image(id="fileInput", onchange="previewImg(event)") }}
            <div class="divider">–∞–±–æ</div>
            <div class="field">
                <label>URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                {{ form.image_url(placeholder="https://...", id="urlInput") }}
            </div>
        </div>

        <div class="form-right">
            <div class="field field--full">
                {{ form.name.label }}
                {{ form.name(placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –§—ñ–ª–∞–¥–µ–ª—å—Ñ—ñ—è —Ä–æ–ª") }}
                {% for e in form.name.errors %}<span class="error">{{ e }}</span>{% endfor %}
            </div>
            <div class="field">
                {{ form.price.label }}
                {{ form.price(placeholder="250.00") }}
                {% for e in form.price.errors %}<span class="error">{{ e }}</span>{% endfor %}
            </div>
            <div class="field">
                {{ form.category_id.label }}
                {{ form.category_id() }}
            </div>
            <div class="field">
                {{ form.weight.label }}
                {{ form.weight(placeholder="350") }}
            </div>
            <div class="field">
                {{ form.calories.label }}
                {{ form.calories(placeholder="450") }}
            </div>
            <div class="field">
                {{ form.cooking_time.label }}
                {{ form.cooking_time(placeholder="20") }}
            </div>
            <div class="field field--full">
                {{ form.description.label }}
                {{ form.description(placeholder="–û–ø–∏—Å —Å—Ç—Ä–∞–≤–∏...") }}
            </div>
            <div class="field field--full">
                {{ form.ingredients.label }}
                {{ form.ingredients(placeholder="—Ä–∏—Å, –ª–æ—Å–æ—Å—å, –∞–≤–æ–∫–∞–¥–æ...") }}
            </div>
            <button type="submit" class="btn btn--primary">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
        </div>
    </form>
</div>

<div class="products-section">
    <div class="products-section__head">
        <div class="products-section__title">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤</div>
    </div>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>–§–æ—Ç–æ</th>
                <th>–ù–∞–∑–≤–∞</th>
                <th>–¶—ñ–Ω–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î—ñ—è</th>
            </tr>
        </thead>
        <tbody>
            {% for p in products %}
            <tr>
                <td>{{ p.id }}</td>
                <td><img class="product-thumb" src="{{ p.image_url or 'https://images.unsplash.com/photo-1553621042-f6e147245754?w=120' }}" alt="{{ p.name }}"></td>
                <td>
                    <div class="product-name">{{ p.name }}</div>
                    {% if p.category %}<div class="product-cat">{{ p.category.name }}</div>{% endif %}
                </td>
                <td>{{ p.price }} ‚Ç¥</td>
                <td>
                    {% if not p.is_deleted %}
                        <span class="badge badge--active">–ê–∫—Ç–∏–≤–Ω–∏–π</span>
                    {% else %}
                        <span class="badge badge--deleted">–í–∏–¥–∞–ª–µ–Ω–æ</span>
                    {% endif %}
                </td>
                <td>
                    <form action="{{ url_for('main.admin_toggle_product', product_id=p.id) }}" method="POST" style="margin:0">
                        {{ toggle_forms[p.id].hidden_tag() }}
                        <button type="submit" class="btn btn--ghost" style="padding:.35rem .8rem;font-size:.75rem">
                            {{ '–í—ñ–¥–Ω–æ–≤–∏—Ç–∏' if p.is_deleted else '–í–∏–¥–∞–ª–∏—Ç–∏' }}
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
function previewImg(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('urlInput').value = '';
    const reader = new FileReader();
    reader.onload = ev => {
        const area = document.getElementById('uploadArea');
        let img = area.querySelector('img');
        if (!img) { img = document.createElement('img'); area.appendChild(img); }
        img.src = ev.target.result;
        area.querySelector('.upload-area__icon').style.display = 'none';
        area.querySelector('.upload-area__text').style.display = 'none';
        area.querySelector('.upload-area__hint').style.display = 'none';
    };
    reader.readAsDataURL(file);
}
function removeImg(e) {
    e.stopPropagation();
    document.getElementById('fileInput').value = '';
    document.getElementById('urlInput').value = '';
    const area = document.getElementById('uploadArea');
    const img = area.querySelector('img');
    if (img) img.remove();
    area.querySelector('.upload-area__icon').style.display = '';
    area.querySelector('.upload-area__text').style.display = '';
    area.querySelector('.upload-area__hint').style.display = '';
}
// Drag & drop
const area = document.getElementById('uploadArea');
area.addEventListener('dragover', e => { e.preventDefault(); area.style.borderColor = 'var(--ink)'; });
area.addEventListener('dragleave', () => area.style.borderColor = '');
area.addEventListener('drop', e => {
    e.preventDefault(); area.style.borderColor = '';
    if (e.dataTransfer.files[0]) {
        document.getElementById('fileInput').files = e.dataTransfer.files;
        previewImg({ target: { files: e.dataTransfer.files } });
    }
});
</script>
{% endblock %}
