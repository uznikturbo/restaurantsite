{% extends "base.html" %}
{% block title %}Кошик — 桜 Sakura{% endblock %}

{% block extra_css %}
<style>
.cart-layout {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 2rem;
    align-items: start;
}

.cart-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2.2rem;
    font-weight: 300;
    margin-bottom: 1.75rem;
}

.cart-item {
    background: #fff;
    border: 1px solid rgba(26,18,8,.07);
    border-radius: 6px;
    display: flex;
    gap: 1.25rem;
    padding: 1.25rem;
    margin-bottom: .75rem;
    transition: box-shadow .2s;
}
.cart-item:hover { box-shadow: 0 4px 20px var(--shadow); }

.cart-item__img {
    width: 90px; height: 90px;
    border-radius: 4px;
    object-fit: cover;
    flex-shrink: 0;
}

.cart-item__body { flex: 1; display: flex; flex-direction: column; gap: .35rem; }

.cart-item__name {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.2rem;
    font-weight: 400;
}

.cart-item__price {
    font-size: .9rem;
    color: rgba(26,18,8,.5);
}

.cart-item__controls { display: flex; gap: .5rem; align-items: center; margin-top: auto; }

.qty-form { display: flex; align-items: center; gap: .35rem; }
.qty-btn {
    width: 28px; height: 28px;
    border: 1px solid rgba(26,18,8,.15);
    border-radius: 2px;
    background: transparent;
    cursor: pointer;
    font-size: .95rem;
    display: flex; align-items: center; justify-content: center;
    transition: all .2s;
}
.qty-btn:hover { background: var(--ink); color: #fff; border-color: var(--ink); }
.qty-num {
    width: 36px; text-align: center;
    border: 1px solid rgba(26,18,8,.12);
    border-radius: 2px;
    padding: .2rem;
    font-size: .9rem;
}

.remove-btn {
    margin-left: auto;
    padding: .3rem .7rem;
    border: 1px solid rgba(192,57,43,.25);
    border-radius: 2px;
    background: transparent;
    color: var(--red);
    font-size: .75rem;
    letter-spacing: .06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all .2s;
}
.remove-btn:hover { background: var(--red); color: #fff; }

/* Summary sidebar */
.cart-summary {
    background: #fff;
    border: 1px solid rgba(26,18,8,.07);
    border-radius: 6px;
    padding: 2rem;
    position: sticky;
    top: 80px;
}

.cart-summary__title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    font-weight: 400;
    margin-bottom: 1.5rem;
}

.cart-summary__row {
    display: flex; justify-content: space-between;
    padding: .6rem 0;
    border-bottom: 1px solid rgba(26,18,8,.06);
    font-size: .88rem;
    color: rgba(26,18,8,.6);
}

.cart-summary__total {
    display: flex; justify-content: space-between;
    padding: 1rem 0 1.5rem;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.8rem;
    font-weight: 300;
}

.order-form { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
.order-form .btn { justify-content: center; padding: .9rem; }

/* Empty */
.cart-empty { text-align: center; padding: 5rem 2rem; }
.cart-empty h2 { font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:300;margin-bottom:.5rem; }
.cart-empty p { color: rgba(26,18,8,.5); margin-bottom: 2rem; }

@media (max-width: 860px) {
    .cart-layout { grid-template-columns: 1fr; }
    .cart-summary { position: static; }
}
</style>
{% endblock %}

{% block content %}
{% if items %}
<div class="cart-layout">
    <div>
        <h1 class="cart-title">Кошик</h1>

        {% for item in items %}
        <div class="cart-item">
            <img class="cart-item__img"
                 src="{{ item.product.image_url or 'https://images.unsplash.com/photo-1553621042-f6e147245754?w=200' }}"
                 alt="{{ item.product.name }}">
            <div class="cart-item__body">
                <div class="cart-item__name">{{ item.product.name }}</div>
                <div class="cart-item__price">{{ item.product.price }} ₴ × {{ item.quantity }} = {{ "%.2f"|format(item.product.price * item.quantity) }} ₴</div>

                <div class="cart-item__controls">
                    <form action="{{ url_for('main.update_cart', item_id=item.id) }}" method="POST" class="qty-form">
                        {{ update_form.hidden_tag() }}
                        <button type="button" class="qty-btn" onclick="changeQty({{ item.id }}, -1)">−</button>
                        <input class="qty-num" type="number" name="quantity" value="{{ item.quantity }}" min="1" id="qty-{{ item.id }}">
                        <button type="button" class="qty-btn" onclick="changeQty({{ item.id }}, 1)">+</button>
                    </form>

                    <form action="{{ url_for('main.remove_from_cart', item_id=item.id) }}" method="POST" style="margin:0">
                        {{ remove_form.hidden_tag() }}
                        <button type="submit" class="remove-btn">Видалити</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="cart-summary">
        <div class="cart-summary__title">Оформлення</div>

        {% for item in items %}
        <div class="cart-summary__row">
            <span>{{ item.product.name }} ×{{ item.quantity }}</span>
            <span>{{ "%.2f"|format(item.product.price * item.quantity) }} ₴</span>
        </div>
        {% endfor %}

        <div class="cart-summary__total">
            <span>До сплати</span>
            <span>
                {% set total = namespace(v=0) %}
                {% for item in items %}{% set total.v = total.v + item.product.price * item.quantity %}{% endfor %}
                {{ "%.2f"|format(total.v) }} ₴
            </span>
        </div>

        <form action="{{ url_for('main.create_order') }}" method="POST" class="order-form">
            {{ order_form.hidden_tag() }}

            <div class="field">
                {{ order_form.order_type.label }}
                {{ order_form.order_type() }}
            </div>

            <div class="field">
                {{ order_form.phone.label }}
                {{ order_form.phone(placeholder="+380 XX XXX XX XX") }}
                {% for err in order_form.phone.errors %}<span class="error">{{ err }}</span>{% endfor %}
            </div>

            <div class="field" id="addressField">
                {{ order_form.address.label }}
                {{ order_form.address(placeholder="вул. Приклад, 123") }}
            </div>

            <button type="submit" class="btn btn--primary">Замовити та оплатити</button>
        </form>
    </div>
</div>

{% else %}
<div class="cart-empty">
    <h2>Кошик порожній</h2>
    <p>Додайте смачні страви зі сторінки меню</p>
    <a href="{{ url_for('main.menu') }}" class="btn btn--primary">До меню</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function changeQty(id, delta) {
    const inp = document.getElementById('qty-' + id);
    let v = parseInt(inp.value) + delta;
    if (v < 1) v = 1;
    inp.value = v;
    inp.closest('form').submit();
}

// Show/hide address field
const typeSelect = document.querySelector('[name="order_type"]');
const addrField = document.getElementById('addressField');
if (typeSelect && addrField) {
    function toggleAddr() {
        addrField.style.display = typeSelect.value === 'delivery' ? '' : 'none';
    }
    typeSelect.addEventListener('change', toggleAddr);
    toggleAddr();
}
</script>
{% endblock %}
