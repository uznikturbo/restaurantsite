{% extends "base.html" %}
{% block title %}–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è ‚Äî Ê°ú Sakura{% endblock %}

{% block extra_css %}
<style>
.book-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 2rem;
    align-items: start;
}

.section-eyebrow { font-size:.7rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);margin-bottom:.5rem; }
.section-h { font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:300;margin-bottom:1.5rem; }

/* Floor plan */
.floor-card { background:#fff;border:1px solid rgba(26,18,8,.08);border-radius:6px;overflow:hidden; }
.floor-card__head { padding:1.25rem 1.5rem;border-bottom:1px solid rgba(26,18,8,.06); display:flex;justify-content:space-between;align-items:center; }
.floor-card__title { font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:400; }
.floor-legend { display:flex;gap:1.25rem;font-size:.75rem;color:rgba(26,18,8,.5); }
.floor-legend span { display:flex;align-items:center;gap:.3rem; }

.floor-surface {
    position: relative;
    height: 520px;
    background: #a08570;
    overflow-x: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(26,18,8,.3) transparent;
}

.floor-map {
    position: relative;
    min-width: 820px;
    height: 100%;
}

/* Tables */
.t-wrap {
    position: absolute;
    cursor: pointer;
    user-select: none;
    transition: transform .2s;
}
.t-wrap:hover:not(.t-wrap--occupied) { transform: scale(1.08); z-index: 10; }
.t-wrap--occupied { opacity: .4; cursor: not-allowed; filter: grayscale(60%); }
.t-wrap--selected { transform: scale(1.1); z-index: 20; }
.t-wrap--selected::before {
    content:'‚ú¶';
    position:absolute;top:-22px;left:50%;transform:translateX(-50%);
    color:var(--gold);font-size:1.1rem;
    animation: glow 1.5s infinite;
}
@keyframes glow { 0%,100%{opacity:1}50%{opacity:.5} }

.t-top {
    display:flex;align-items:center;justify-content:center;
    background:radial-gradient(circle at 30% 30%,#a0522d,#5a3012);
    border:3px solid #3d1e0a;
    color:#f4c430;
    font-family:'Cormorant Garamond',serif;
    font-size:1.4rem;
    font-weight:400;
    box-shadow:0 6px 20px rgba(0,0,0,.4),inset 0 1px 3px rgba(255,255,255,.15);
}
.t--round .t-top { width:90px;height:90px;border-radius:50%; }
.t--square .t-top { width:90px;height:90px;border-radius:12px; }
.t--large .t-top { width:150px;height:80px;border-radius:16px; }

.chair {
    position:absolute;
    width:26px;height:26px;
    background:radial-gradient(circle at 35% 35%,#c03520,#7a1c12);
    border-radius:50%;
    border:2px solid #5a1010;
    box-shadow:0 3px 8px rgba(0,0,0,.4);
}

/* Round ‚Äî 2 chairs */
.t--round .chair:nth-child(1) { top:-16px;left:50%;transform:translateX(-50%); }
.t--round .chair:nth-child(2) { bottom:-16px;left:50%;transform:translateX(-50%); }
/* Square ‚Äî 4 chairs */
.t--square .chair:nth-child(1) { top:-16px;left:50%;transform:translateX(-50%); }
.t--square .chair:nth-child(2) { right:-16px;top:50%;transform:translateY(-50%); }
.t--square .chair:nth-child(3) { bottom:-16px;left:50%;transform:translateX(-50%); }
.t--square .chair:nth-child(4) { left:-16px;top:50%;transform:translateY(-50%); }
/* Large ‚Äî 6 chairs */
.t--large .chair { width:24px;height:24px; }
.t--large .chair:nth-child(1) { top:-15px;left:12%; }
.t--large .chair:nth-child(2) { top:-15px;left:50%;transform:translateX(-50%); }
.t--large .chair:nth-child(3) { top:-15px;right:12%; }
.t--large .chair:nth-child(4) { bottom:-15px;left:12%; }
.t--large .chair:nth-child(5) { bottom:-15px;left:50%;transform:translateX(-50%); }
.t--large .chair:nth-child(6) { bottom:-15px;right:12%; }

.t-status {
    position:absolute;top:-8px;right:-8px;
    width:22px;height:22px;border-radius:50%;
    font-size:.6rem;font-weight:700;
    display:flex;align-items:center;justify-content:center;
    border:2px solid #fff;
    box-shadow:0 2px 6px rgba(0,0,0,.3);
    z-index:5;
}
.t-status--on { background:#10b981;color:#fff; }
.t-status--off { background:#ef4444;color:#fff; }

/* Bar */
.bar {
    position:absolute;right:0;top:50%;transform:translateY(-50%);
    width:65px;height:340px;
    background:linear-gradient(180deg,#3d2010,#1e0f08);
    border-radius:12px 0 0 12px;
    border:3px solid #1a0a04;
    border-right:none;
    box-shadow:-4px 0 20px rgba(0,0,0,.5);
    z-index:5;
    display:flex;align-items:center;justify-content:center;
}
.bar-text {
    writing-mode:vertical-rl;
    font-family:'Cormorant Garamond',serif;
    font-size:.85rem;
    letter-spacing:.2em;
    text-transform:uppercase;
    color:rgba(201,168,76,.7);
}

/* Form sidebar */
.book-form-card {
    background:#fff;
    border:1px solid rgba(26,18,8,.08);
    border-radius:6px;
    padding:2rem;
    position:sticky;
    top:80px;
}
.book-form-card__title { font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:400;margin-bottom:1.5rem; }

.selected-info {
    background:linear-gradient(135deg,#fef3c7,#fde68a);
    border:1px solid rgba(245,158,11,.4);
    border-radius:4px;
    padding:1rem 1.25rem;
    margin-bottom:1.5rem;
    font-size:.9rem;
    color:#78350f;
    display:none;
}
.selected-info.visible { display:block; }
.selected-info strong { display:block;font-family:'Cormorant Garamond',serif;font-size:1.2rem;margin-bottom:.2rem; }

.hint-msg {
    font-size:.82rem;
    color:rgba(26,18,8,.4);
    text-align:center;
    padding:.75rem;
    border:1px dashed rgba(26,18,8,.12);
    border-radius:4px;
    margin-bottom:1.5rem;
}

.book-form { display:flex;flex-direction:column;gap:1.1rem; }
.book-form .btn { justify-content:center;padding:.85rem; }

/* Special offers */
.offers { margin-top:3rem; }
.offers-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1px;background:rgba(26,18,8,.08);border-radius:6px;overflow:hidden;margin-top:1.25rem; }
.offer { background:#fff;padding:1.75rem; }
.offer:hover { background:var(--paper); }
.offer__icon { font-size:1.4rem;margin-bottom:.75rem; }
.offer__title { font-family:'Cormorant Garamond',serif;font-size:1.1rem;font-weight:400;margin-bottom:.25rem; }
.offer__text { font-size:.82rem;color:rgba(26,18,8,.5);line-height:1.6; }

@media (max-width: 1000px) {
    .book-layout { grid-template-columns:1fr; }
    .book-form-card { position:static; }
}
</style>
{% endblock %}

{% block content %}
<div class="section-eyebrow">–†–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è</div>
<h1 class="section-h" style="margin-bottom:2rem;">–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ —Å—Ç–æ–ª–∏–∫</h1>

<div class="book-layout">
    <div>
        <div class="floor-card">
            <div class="floor-card__head">
                <span class="floor-card__title">–ü–ª–∞–Ω –∑–∞–ª—É</span>
                <div class="floor-legend">
                    <span><span style="color:#10b981">‚óè</span> –í—ñ–ª—å–Ω–∏–π</span>
                    <span><span style="color:var(--gold)">‚ú¶</span> –û–±—Ä–∞–Ω–∏–π</span>
                    <span><span style="color:#ef4444">‚óè</span> –ó–∞–π–Ω—è—Ç–∏–π</span>
                </div>
            </div>
            <div class="floor-surface">
                <div class="floor-map" id="floorMap">
                    <div class="bar"><span class="bar-text">Bar</span></div>
                </div>
            </div>
        </div>

        <!-- Offers -->
        <div class="offers">
            <div class="section-eyebrow">–°–ø–µ—Ü–ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</div>
            <div class="offers-grid">
                <div class="offer"><div class="offer__icon">üéÇ</div><div class="offer__title">–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</div><p class="offer__text">–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –¥–µ—Å–µ—Ä—Ç –¥–ª—è —ñ–º–µ–Ω–∏–Ω–Ω–∏–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—ñ</p></div>
                <div class="offer"><div class="offer__icon">üíë</div><div class="offer__title">–†–æ–º–∞–Ω—Ç–∏—á–Ω–∞ –≤–µ—á–µ—Ä—è</div><p class="offer__text">–°—Ç–æ–ª–∏–∫ –±—ñ–ª—è –≤—ñ–∫–Ω–∞ –∑—ñ —Å–≤—ñ—á–∫–∞–º–∏ –¥–ª—è –¥–≤–æ—Ö</p></div>
                <div class="offer"><div class="offer__icon">üçæ</div><div class="offer__title">–ë—ñ–∑–Ω–µ—Å-–ª–∞–Ω—á</div><p class="offer__text">–ó–Ω–∏–∂–∫–∞ 15% –∑ 12:00 –¥–æ 15:00 —É –±—É–¥–Ω—ñ</p></div>
            </div>
        </div>
    </div>

    <div class="book-form-card">
        <div class="book-form-card__title">–î–µ—Ç–∞–ª—ñ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</div>

        <div class="hint-msg" id="hintMsg">–û–±–µ—Ä—ñ—Ç—å —Å—Ç–æ–ª–∏–∫ –Ω–∞ –ø–ª–∞–Ω—ñ –∑–∞–ª—É</div>

        <div class="selected-info" id="selectedInfo">
            <strong id="selTableName">‚Äî</strong>
            <span id="selTableSeats">‚Äî</span>
        </div>

        <form action="{{ url_for('main.create_reservation') }}" method="POST" class="book-form" id="bookForm">
            {{ form.hidden_tag() }}
            {{ form.table_id(id="tableIdInput") }}

            <div class="field">
                {{ form.reserved_at.label }}
                {{ form.reserved_at(id="reservedAt") }}
                {% for err in form.reserved_at.errors %}<span class="error">{{ err }}</span>{% endfor %}
            </div>

            <div class="field">
                {{ form.guests.label }}
                {{ form.guests() }}
                {% for err in form.guests.errors %}<span class="error">{{ err }}</span>{% endfor %}
            </div>

            <div class="field">
                {{ form.phone.label }}
                {{ form.phone(placeholder="+380 XX XXX XX XX") }}
                {% for err in form.phone.errors %}<span class="error">{{ err }}</span>{% endfor %}
            </div>

            <div class="field">
                {{ form.comment.label }}
                {{ form.comment(placeholder="–û—Å–æ–±–ª–∏–≤—ñ –ø–æ–±–∞–∂–∞–Ω–Ω—è...") }}
            </div>

            <button type="submit" class="btn btn--primary" id="submitBtn" disabled>–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const tables = {{ tables_data | tojson }};
const map = document.getElementById('floorMap');
const tableIdInput = document.getElementById('tableIdInput');
const submitBtn = document.getElementById('submitBtn');
const selectedInfo = document.getElementById('selectedInfo');
const selTableName = document.getElementById('selTableName');
const selTableSeats = document.getElementById('selTableSeats');
const hintMsg = document.getElementById('hintMsg');
let selectedId = null;

const seatsMap = { round: 2, square: 4, large: 6 };

function createChairs(type) {
    return Array.from({ length: seatsMap[type] || 2 }, () => '<div class="chair"></div>').join('');
}

tables.forEach(t => {
    const wrap = document.createElement('div');
    wrap.className = `t-wrap t--${t.type}${t.available ? '' : ' t-wrap--occupied'}`;
    wrap.style.left = t.x + 'px';
    wrap.style.top  = t.y + 'px';
    wrap.dataset.id = t.id;
    wrap.innerHTML = `
        <div class="t-top">
            ${createChairs(t.type)}
            ${t.number}
        </div>
        <div class="t-status ${t.available ? 't-status--on' : 't-status--off'}">${t.available ? '‚úì' : '‚úï'}</div>`;

    if (t.available) {
        wrap.addEventListener('click', () => selectTable(t, wrap));
    }
    map.appendChild(wrap);
});

// Default datetime
const ra = document.getElementById('reservedAt');
if (ra) {
    const now = new Date();
    now.setDate(now.getDate());
    now.setHours(19, 0, 0, 0);
    ra.min = new Date().toISOString().slice(0, 16);
    ra.value = now.toISOString().slice(0, 16);
}

function selectTable(t, wrap) {
    document.querySelectorAll('.t-wrap').forEach(w => w.classList.remove('t-wrap--selected'));
    wrap.classList.add('t-wrap--selected');
    selectedId = t.id;
    tableIdInput.value = t.id;

    selTableName.textContent = `–°—Ç–æ–ª–∏–∫ ‚Ññ${t.number}`;
    selTableSeats.textContent = `${seatsMap[t.type] || t.seats || '‚Äî'} –º—ñ—Å—Ü—å`;
    selectedInfo.classList.add('visible');
    hintMsg.style.display = 'none';
    submitBtn.disabled = false;
}
</script>
{% endblock %}
